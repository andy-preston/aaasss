/var/tmp/demo.asm
=================
                      1     .device("ATTiny24")
                      2     .include("def.asm")

/var/tmp/def.asm
================
                      1     ; A macro can be defined in one file and used in another
                      2     .macro("aMacro", "address")
                      3 loopy:
                      4     DEC R30
                      5     BRNE loopy
                      6     LDS R30, address
                      7     .end()
                      8

/var/tmp/demo.asm
=================
                      3     .aMacro(1024)
                      3 loopy:
000000 EA 95          3     DEC R30
000001 F1 F7          3     BRNE loopy
000002 E0 91 00 04    3     LDS R30, address
                      4
                      5     ; Any directives included in a macro will be recorded
                      6     ; but not be executed during definition
                      7     .macro("pokingMacro")
                      8     .poke("testing")
                      9     LDI R30, 23
                     10     .end()
                     11
                     12     .pokingMacro()
000004 74 65 73 74   12     .poke("testing")
000006 69 6E 67 00
000008 E7 E1         12     LDI R30, 23
                     13
                     14     ; A macro can be called from inside another macro
                     15     .macro("innerMacro", "address")
                     16     LDS R30, address
                     17     .end()
                     18
                     19     .macro("outerMacro")
                     20     .innerMacro(1024)
                     21     .innerMacro(2048)
                     22     .end()
                     23
                     24     .outerMacro()
                     24     .innerMacro(1024)
000009 E0 91 00 04   24     LDS R30, address
                     24     .innerMacro(2048)
00000B E0 91 00 08   24     LDS R30, address
                     25
                     26     ; Playing back multiple copies of a macro with JS
                     27     ; Doing stuff in a loop means that the macros get expanded in
                     28     ; reverse order - hence the reversing of the array
                     29     .([1024, 2048].reverse().forEach(a => aMacro(a)))
                     29 loopy:
00000D EA 95         29     DEC R30
00000E F1 F7         29     BRNE loopy
00000F E0 91 00 04   29     LDS R30, address
                     29 loopy:
000011 EA 95         29     DEC R30
000012 F1 F7         29     BRNE loopy
000013 E0 91 00 08   29     LDS R30, address
                     30
                     31     ; A macro parameter could be used as part of an expression
                     32     .macro("expressionMacro", "baseValue")
                     33     LDI R23, baseValue + 5
                     34     LDI R23, 15
                     35     .end()
                     36     .expressionMacro(10)
000015 7F E0         36     LDI R23, baseValue + 5
000016 7F E0         36     LDI R23, 15
                     37
                     38     ; Labels can be internal to a macro, or global across the program
                     39 outerLabel:
000017 00 00         40     nop
000018 00 00         41     nop
000019 00 00         42     nop
                     43     .macro("jumpMacro")
                     44 innerLabel:
                     45     rjmp outerLabel
                     46     rjmp innerLabel
                     47     .end()
                     48     .jumpMacro()
                     48 innerLabel:
00001A FC CF         48     rjmp outerLabel
00001B FE CF         48     rjmp innerLabel
                     49     .jumpMacro()
                     49 innerLabel:
00001C FA CF         49     rjmp outerLabel
00001D FE CF         49     rjmp innerLabel
                     50
                     51     ; Should we expect to see LDS R30, 1024
                     52     ;                      or LDS R30, address
                     53     .aMacro(1024)
                     53 loopy:
00001E EA 95         53     DEC R30
00001F F1 F7         53     BRNE loopy
000020 E0 91 00 04   53     LDS R30, address
                     54     .aMacro(2048)
                     54 loopy:
000022 EA 95         54     DEC R30
000023 F1 F7         54     BRNE loopy
000024 E0 91 00 08   54     LDS R30, address
                     55
                     56     ; Macro parameters can only be numbers or strings
                     57     .aMacro(false)
                        parameter_type
                        location.parameter: 1
                        expected: string, number: (address)
                        actual: boolean: (false)
                     58

Symbol Table
============

address (aMacro 1)            | 1024 | 0400 | /var/tmp/demo.asm:3  |  1
address (aMacro 2)            | 2048 | 0800 | /var/tmp/demo.asm:29 |  1
address (aMacro 3)            | 1024 | 0400 | /var/tmp/demo.asm:29 |  1
address (aMacro 4)            | 1024 | 0400 | /var/tmp/demo.asm:53 |  1
address (aMacro 5)            | 2048 | 0800 | /var/tmp/demo.asm:54 |  1
address (innerMacro 1)        | 1024 | 0400 | /var/tmp/demo.asm:24 |  1
address (innerMacro 2)        | 2048 | 0800 | /var/tmp/demo.asm:24 |  1
aMacro                        |      |      | /var/tmp/def.asm:7   |  6
baseValue (expressionMacro 1) |   10 |   0A | /var/tmp/demo.asm:36 |  1
expressionMacro               |      |      | /var/tmp/demo.asm:35 |  1
innerLabel (jumpMacro 1)      |   26 |   1A | /var/tmp/demo.asm:48 |  1
innerLabel (jumpMacro 2)      |   28 |   1C | /var/tmp/demo.asm:49 |  1
innerMacro                    |      |      | /var/tmp/demo.asm:17 |  2
jumpMacro                     |      |      | /var/tmp/demo.asm:47 |  2
loopy (aMacro 1)              |    0 |   00 | /var/tmp/demo.asm:3  |  1
loopy (aMacro 2)              |   17 |   11 | /var/tmp/demo.asm:29 |  1
loopy (aMacro 3)              |   13 |   0D | /var/tmp/demo.asm:29 |  1
loopy (aMacro 4)              |   30 |   1E | /var/tmp/demo.asm:53 |  1
loopy (aMacro 5)              |   34 |   22 | /var/tmp/demo.asm:54 |  1
outerLabel                    |   23 |   17 | /var/tmp/demo.asm:39 |  2
outerMacro                    |      |      | /var/tmp/demo.asm:22 |  1
pokingMacro                   |      |      | /var/tmp/demo.asm:10 |  1
R23                           |      |      | REGISTER             |  2
R30                           |      |      | REGISTER             | 13